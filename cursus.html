<!DOCTYPE html>
<html lang="en">
<head>
    <title>Banana Spoon</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="img/favicon.png">
    <!-- Bootstrap CDN -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
          integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T"
          crossorigin="anonymous">
    <!-- Custom Stylesheet -->
    <link rel="stylesheet" href="css/style.css">
    <script src="js/jquery-1.12.1.min.js"></script>
    <script src="js/lang.js"></script>
    <script src="js/parse.js"></script>
</head>
<body>
    <div class="bg">
        <h3>מקצועות החובה</h3>
        <div class="flex-div">
            <div id="req-missing-display" style="color: white; text-align: right; direction: rtl;">
                <h3>קורסים חסרים</h3>
                <ul id="req-missing-list"></ul>
            </div>
            <div id="req-taken-display" style="color: white; text-align: right; direction: rtl;">
                <h3>קורסים שלקחת</h3>
                <ul id="req-taken-list"></ul>
            </div>
        </div>
    </div>    
    <script>
        function getCourseName(array, courseNumber) {
            for (let i = 0; i < array.length; i++) {
                if (array[i][0] === courseNumber) {
                    return array[i][1].name;
                }
            }
            return null; 
        }

        function processSemester(semesterCourses, reqMissing, required, facID) {
            let reqTaken = [];
            let alternativeCourses = [];
            for (let j in semesterCourses) {
                let courseNum = semesterCourses[j]["course-number"];
                if (reqMissing.includes(courseNum)) {
                    reqTaken.push(courseNum);
                    reqMissing = reqMissing.filter(course => course !== courseNum);
                } else {
                    // Check for alternative courses
                    for (let k in required[facID]) {
                        const course = required[facID][k];
                        if (course["alternatives"] && course["alternatives"].includes(courseNum)) {
                            alternativeCourses.push(course["course-number"]);
                            reqTaken.push(courseNum);
                        }
                    }
                }
            }
            // Remove the original courses from the reqMissing array
            reqMissing = reqMissing.filter(course => !alternativeCourses.includes(course));
            return { reqTaken, reqMissing };
        }

        function checkCatalog(data, faculties, courses, required) {
            let faculty = data["faculty"];
            if (faculties.includes(faculty)) {
                let facID = faculties.indexOf(faculty);
                let reqTaken = [];
                let reqMissing = required[facID].map(course => course["course-number"]);
    
                // Process exemptions
                let result = processSemester(data["exemptions"], reqMissing, required, facID);
                reqTaken = result.reqTaken;
                reqMissing = result.reqMissing;

                // Process each semester
                for (let i in data["semesters"]) {
                    let semesterCourses = data["semesters"][i]["courses"];
                    let result = processSemester(semesterCourses, reqMissing, required, facID);
                    reqTaken = reqTaken.concat(result.reqTaken);
                    reqMissing = result.reqMissing;
                }
    
                // Display courses taken
                let reqTakenList = document.getElementById('req-taken-list');
                reqTakenList.innerHTML = '';
                for (let i in reqTaken) {
                    let courseName = getCourseName(courses, reqTaken[i]);
                    if (courseName) {
                        reqTakenList.innerHTML += `<li>[<a href="https://students.technion.ac.il/local/technionsearch/course/${reqTaken[i]}" target="blank">${reqTaken[i]}</a>] ${courseName}</li>`;
                    } else {
                        reqTakenList.innerHTML += `<li>[<a href="https://students.technion.ac.il/local/technionsearch/course/${reqTaken[i]}" target="blank">${reqTaken[i]}</a>]</li>`;
                        console.log("Missing course: " + reqTaken[i]);
                    }
                }
                // Display courses missing
                let reqMissingList = document.getElementById('req-missing-list');
                reqMissingList.innerHTML = '';
                for (let i in reqMissing) {
                    let courseName = getCourseName(courses, reqMissing[i]);
                    if (courseName) {
                        reqMissingList.innerHTML += `<li>[<a href="https://students.technion.ac.il/local/technionsearch/course/${reqMissing[i]}" target="blank">${reqMissing[i]}</a>] ${courseName}</li>`;
                    } else {
                        reqMissingList.innerHTML += `<li>[<a href="https://students.technion.ac.il/local/technionsearch/course/${reqMissing[i]}" target="blank">${reqMissing[i]}</a>]</li>`;
                        console.log("Missing course: " + reqMissing[i]);
                    }
                }
            } else {
                console.log("No catalog found.");
            }
        }

        const MErequired = [
            {"course-number": "104018", "semester": ["winter"]},
            {"course-number": "104016", "semester": ["winter"]},
            {"course-number": "125001", "semester": ["winter"]},
            {"course-number": "234128", "semester": ["winter"], "alternatives": ["234130"]},
            {"course-number": "324033", "semester": ["winter"]},
            {"course-number": "034042", "semester": ["spring"], "alternatives": ["034048"]},
            {"course-number": "034028", "semester": ["spring"]},
            {"course-number": "104022", "semester": ["spring"]},
            {"course-number": "114051", "semester": ["spring"]},
            {"course-number": "104131", "semester": ["spring"]},
            {"course-number": "125013", "semester": ["spring"]},
            {"course-number": "314533", "semester": ["spring"]},
            {"course-number": "034029", "semester": ["winter"]},
            {"course-number": "034043", "semester": ["winter"]},
            {"course-number": "034033", "semester": ["winter"], "alternatives": ["034056"]},
            {"course-number": "034035", "semester": ["winter"]},
            {"course-number": "104228", "semester": ["winter"]},
            {"course-number": "114052", "semester": ["winter"]},
            {"course-number": "034030", "semester": ["spring"]},
            {"course-number": "034010", "semester": ["spring"]},
            {"course-number": "034013", "semester": ["spring"], "alternatives": ["034055"]},
            {"course-number": "034015", "semester": ["spring"]},
            {"course-number": "034032", "semester": ["spring"]},
            {"course-number": "034041", "semester": ["winter"]},
            {"course-number": "034040", "semester": ["winter"]},
            {"course-number": "034022", "semester": ["winter"]},
            {"course-number": "034371", "semester": ["winter"]},
            {"course-number": "094481", "semester": ["winter"]},
            {"course-number": "114081", "semester": ["winter"]},
            {"course-number": "114054", "semester": ["winter"]},
            {"course-number": "034034", "semester": ["spring"]},
            {"course-number": "034044", "semester": ["spring"]},
            {"course-number": "114082", "semester": ["spring"]},
            {"course-number": "034039", "semester": ["winter"]}
        ];

        const required = [MErequired];
        const faculties = ["הנדסת מכונות"];
        const parsedData = JSON.parse(localStorage.getItem('parsedData'));

        let courses = [];
        $.getJSON("files/course_list.json", function(json) {
            courses = Object.keys(json).map((key) => [key, json[key]]);
            checkCatalog(parsedData, faculties, courses, required);
        });
    </script>
</body>
</html>
